<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <title>Raspadinha</title>
    <style>
        :root {
            --w: 800px;
            --h: 500px;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            background: #333;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: Arial, sans-serif;
            position: relative;
        }
        #stage {
            position: relative;
            width: var(--w);
            height: var(--h);
            box-shadow: 0 0 15px rgba(0,0,0,0.6);
            border-radius: 12px;
            overflow: hidden;
            background: #111;
        }
        #bgCanvas, #coverCanvas {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            image-rendering: auto;
        }
        .flash {
            position: fixed;
            inset: 0;
            background: white;
            opacity: 0;
            pointer-events: none;
            transition: opacity .5s ease-out;
        }
        .flash.active { opacity: .6; }
        #sidebar {
            position: absolute;
            top: 16px;
            right: 16px;
            width: auto;
            max-width: 300px;
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 14px;
            padding: 12px 16px;
            line-height: 1.3;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }
        #sidebar h3 {
            margin: 0 0 8px;
            font-size: 16px;
            border-bottom: 1px solid #555;
            padding-bottom: 6px;
        }
        #sidebar p { margin: 8px 0; word-break: break-all; }
        #status { font-size: 12px; color: #aaa; }

        /* Botão de início fora do canvas */
        #startBtn {
            position: absolute;
            top: calc(50% - 300px - 40px);
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            background-color: #606160;
            color: #fff;
            cursor: pointer;
            opacity: 0;
            pointer-events: none;
            transition: opacity 3s ease;
            z-index: 10;
        }
        #startBtn.show { opacity: 1; pointer-events: auto; }

        /* Cronômetro */
        #timer {
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
            color: #fff;
            font-weight: bold;
            display: none;
            z-index: 10;
            opacity: 1;
            transition: opacity 0.5s ease;
        }
    </style>
</head>
<body>
    <div id="stage">
        <canvas id="bgCanvas" width="800" height="500"></canvas>
        <canvas id="coverCanvas" width="800" height="500"></canvas>
    </div>

    <button id="startBtn">Começar a Raspadinha</button>
    <div id="timer"></div>

    <div id="sidebar">
        <h3>Configuração (debug)</h3>
        <p><b>Imagem:</b> <span id="imgPath"></span></p>
        <p><b>Som:</b> <span id="soundPath"></span></p>
        <p><b>Raio:</b> <span id="radiusVal"></span></p>
        <p><b>Força:</b> <span id="strengthVal"></span></p>
        <p><b>Meta (%):</b> <span id="thresholdVal"></span></p>
        <hr>
        <p><b>Revelado (%):</b> <span id="progressVal">0</span></p>
        <p id="status"></p>
    </div>

    <div class="flash" id="flash"></div>

    <script>
        const defaultConfig = {
            image: "assets/imagens/premio.gif",
            fallbackImage: "https://picsum.photos/800/500",
            sound: "assets/sons/sucesso.mp3",
            fallbackSound: "https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg",
            erase: { radius: 40, strength: 0.85 },
            clearThreshold: 0.8
        };

        const bgCanvas = document.getElementById('bgCanvas');
        const coverCanvas = document.getElementById('coverCanvas');
        const bgCtx = bgCanvas.getContext('2d');
        const coverCtx = coverCanvas.getContext('2d', { willReadFrequently: true });
        const flash = document.getElementById('flash');
        const imgPathEl = document.getElementById('imgPath');
        const soundPathEl = document.getElementById('soundPath');
        const radiusValEl = document.getElementById('radiusVal');
        const strengthValEl = document.getElementById('strengthVal');
        const thresholdValEl = document.getElementById('thresholdVal');
        const progressValEl = document.getElementById('progressVal');
        const statusEl = document.getElementById('status');
        const startBtn = document.getElementById('startBtn');
        const timerEl = document.getElementById('timer');
        const W = bgCanvas.width, H = bgCanvas.height;
        let config = defaultConfig;
        let audio = null;
        let isDrawing = false;
        let gameEnded = false;
        let moveTick = 0;
        let inputEnabled = false;
        let timerInterval = null;

        (async function init() {
            try {
                const res = await fetch('config.json', { cache: 'no-store' });
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const data = await res.json();
                config = { ...defaultConfig, ...data };
                statusEl.textContent = "Config carregada de config.json.";
            } catch (e) {
                statusEl.textContent = "Falha ao ler config.json. Usando defaults.";
                console.warn('Erro ao carregar config.json:', e);
            }
            start();
        })();

        function start() {
            imgPathEl.textContent = config.image;
            soundPathEl.textContent = config.sound;
            radiusValEl.textContent = config.erase.radius;
            strengthValEl.textContent = config.erase.strength;
            thresholdValEl.textContent = (config.clearThreshold * 100) + "%";

            const img = new Image();
            img.crossOrigin = "anonymous";
            img.onload = () => {
                bgCtx.fillStyle = "#111";
                bgCtx.fillRect(0,0,W,H);
                bgCtx.drawImage(img,0,0,W,H);

                coverCtx.globalCompositeOperation = 'source-over';
                coverCtx.fillStyle = 'rgba(0,0,0,1)';
                coverCtx.fillRect(0,0,W,H);

                setTimeout(() => startBtn.classList.add('show'), 1000);
            };
            img.onerror = () => {
                statusEl.textContent = "Imagem principal indisponível. Usando fallback.";
                img.src = config.fallbackImage;
            };
            img.src = config.image;

            audio = new Audio(config.sound);
            audio.onerror = () => { audio = null; statusEl.textContent += " • Som indisponível."; };
            bindInput();
        }

        // Clique no botão inicia raspadinha + cronômetro
        startBtn.addEventListener('click', () => {
            startBtn.style.display = 'none';
            inputEnabled = true;
            startTimer(6); // 6s
        });

        function startTimer(seconds) {
            let remaining = seconds;
            timerEl.textContent = remaining;
            timerEl.style.display = 'block';
            timerEl.style.opacity = 1;

            timerInterval = setInterval(() => {
                remaining--;
                timerEl.textContent = remaining;
                if (remaining <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    timerEl.style.opacity = 0;
                    setTimeout(() => timerEl.style.display='none',500);
                    inputEnabled = false;
                    playEndSound();
                    setTimeout(()=>{ startBtn.style.display='block'; setTimeout(()=>startBtn.classList.add('show'),50); },500);
                }
            },1000);
        }

        function playEndSound() {
            const endAudio = new Audio("assets/sons/final.mp3");
            endAudio.onerror = () => { 
                const fallback = new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"); 
                fallback.play().catch(()=>{}); 
            };
            endAudio.play().catch(()=>{});
        }

        function getPos(e) {
            const rect = coverCanvas.getBoundingClientRect();
            if(e.touches && e.touches.length) return {x:e.touches[0].clientX - rect.left, y:e.touches[0].clientY - rect.top};
            return {x:e.clientX - rect.left, y:e.clientY - rect.top};
        }

        function scratch(x,y) {
            coverCtx.globalCompositeOperation = "destination-out";
            const r = config.erase.radius;
            const g = coverCtx.createRadialGradient(x,y,0,x,y,r);
            const s = Math.max(0.05,Math.min(1,config.erase.strength));
            g.addColorStop(0,`rgba(0,0,0,${s})`);
            g.addColorStop(1,'rgba(0,0,0,0)');
            coverCtx.fillStyle = g;
            coverCtx.beginPath();
            coverCtx.arc(x,y,r,0,Math.PI*2);
            coverCtx.fill();
            coverCtx.globalCompositeOperation = "source-over";
        }

        function bindInput() {
            coverCanvas.addEventListener('mousedown', e => { if(!inputEnabled) return; isDrawing=true; scratch(getPos(e).x,getPos(e).y); });
            window.addEventListener('mouseup', ()=>isDrawing=false);
            coverCanvas.addEventListener('mousemove', e => { if(!isDrawing||!inputEnabled) return; scratch(getPos(e).x,getPos(e).y); if((++moveTick%3)===0) checkCleared(); });
            coverCanvas.addEventListener('touchstart', e=>{ if(!inputEnabled) return; isDrawing=true; scratch(getPos(e).x,getPos(e).y); },{passive:true});
            coverCanvas.addEventListener('touchend', ()=>isDrawing=false,{passive:true});
            coverCanvas.addEventListener('touchmove', e=>{ if(!isDrawing||!inputEnabled) return; e.preventDefault(); scratch(getPos(e).x,getPos(e).y); if((++moveTick%3)===0) checkCleared();},{passive:false});
        }

        function checkCleared() {
            const data = coverCtx.getImageData(0,0,W,H).data;
            let total = data.length/4;
            let cleared=0;
            const thresholdAlpha=80;
            for(let i=3;i<data.length;i+=4) if(data[i]<=thresholdAlpha) cleared++;
            const percent = cleared/total;
            progressValEl.textContent = (percent*100).toFixed(1)+"%";

            if(!gameEnded && percent>=config.clearThreshold) {
                gameEnded=true;
                // Se cronômetro ativo, pausa e fade-out
                if(timerInterval){
                    clearInterval(timerInterval);
                    timerInterval=null;
                    timerEl.style.opacity=0;
                    setTimeout(()=>timerEl.style.display='none',500);
                }
                inputEnabled=false;
                triggerWin();
                autoClearSmooth();
            }
        }

        function triggerWin() {
            playSuccess();
            flash.classList.add('active');
            setTimeout(()=>flash.classList.remove('active'),500);
        }

        function playSuccess() { if(audio){ audio.currentTime=0; audio.play().catch(beep);} else beep();}
        function beep(){ try{ const Actx=window.AudioContext||window.webkitAudioContext; const ac=new Actx(); const o=ac.createOscillator(); const g=ac.createGain(); o.type='sine'; o.frequency.value=880; g.gain.setValueAtTime(0,ac.currentTime); g.gain.linearRampToValueAtTime(0.2,ac.currentTime+0.01); g.gain.exponentialRampToValueAtTime(0.0001,ac.currentTime+0.35); o.connect(g).connect(ac.destination); o.start(); o.stop(ac.currentTime+0.36); }catch(e){} }

        function autoClearSmooth() {
            const imgData = coverCtx.getImageData(0,0,W,H);
            const data = imgData.data;
            let alphaFactor = 1; // começa com alpha total
            const step = 0.002; // quanto reduzir por frame (0.02 = 2% por frame)
            
            function fade() {
                alphaFactor -= step;
                if(alphaFactor <= 0){
                    coverCtx.clearRect(0,0,W,H);
                    return;
                }
                for(let i=3;i<data.length;i+=4){
                    data[i] = data[i]*alphaFactor; // reduz alpha suavemente
                }
                coverCtx.putImageData(imgData,0,0);
                requestAnimationFrame(fade);
            }
            requestAnimationFrame(fade);
        }

    </script>
</body>
</html>


