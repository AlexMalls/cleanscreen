<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Raspadinha</title>
  <style>
    body {
      margin: 0;
      display: flex;
      height: 100vh;
      background: #ccc; /* fundo cinza */
      overflow: hidden;
      font-family: Arial, sans-serif;
    }
    #gameContainer {
      position: relative;
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #ccc;
    }
    canvas {
      display: block;
      background: #000;
    }
    #flash {
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0.8);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    #flash.active {
      opacity: 1;
    }
    #sidebar {
      width: 250px;
      background: #222;
      color: #fff;
      padding: 15px;
      box-shadow: -2px 0 5px rgba(0,0,0,0.5);
      font-size: 14px;
    }
    #sidebar h2 {
      font-size: 16px;
      margin-top: 0;
    }
    #sidebar p {
      margin: 6px 0;
    }
  </style>
</head>
<body>
  <div id="gameContainer">
    <canvas id="scratchCanvas" width="800" height="500"></canvas>
    <div id="flash"></div>
  </div>

  <div id="sidebar">
    <h2>Debug Config</h2>
    <p><b>Intensidade:</b> <span id="intensity"></span></p>
    <p><b>Meta (%):</b> <span id="threshold"></span></p>
    <p><b>Revelado (%):</b> <span id="currentProgress">0</span></p>
    <p><b>Imagem:</b> <span id="imgPath"></span></p>
    <p><b>√Åudio:</b> <span id="audioPath"></span></p>
  </div>

  <script>
    let canvas = document.getElementById("scratchCanvas");
    let ctx = canvas.getContext("2d");
    let flash = document.getElementById("flash");
    let config = {};
    let bgImage = new Image();
    let audio = new Audio();

    let isDrawing = false;
    let completed = false;
    let lastCheck = 0;

    async function loadConfig() {
      try {
        const res = await fetch("config.json");
        config = await res.json();
      } catch {
        config = {
          imagePath: "https://via.placeholder.com/800x500.png?text=Premio",
          audioPath: "",
          eraseIntensity: 40,
          clearThreshold: 80
        };
      }

      document.getElementById("intensity").textContent = config.eraseIntensity;
      document.getElementById("threshold").textContent = config.clearThreshold;
      document.getElementById("imgPath").textContent = config.imagePath;
      document.getElementById("audioPath").textContent = config.audioPath;

      loadAssets();
    }

    function loadAssets() {
      bgImage.src = config.imagePath || "https://via.placeholder.com/800x500.png?text=Premio";
      bgImage.onload = () => {
        ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      };

      audio = new Audio(config.audioPath || "https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");
    }

    function getPos(e) {
      const rect = canvas.getBoundingClientRect();
      if (e.touches) {
        return {
          x: e.touches[0].clientX - rect.left,
          y: e.touches[0].clientY - rect.top
        };
      }
      return {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
      };
    }

    function scratch(x, y) {
      ctx.globalCompositeOperation = "destination-out";
      const grad = ctx.createRadialGradient(x, y, 0, x, y, config.eraseIntensity);
      grad.addColorStop(0, "rgba(0,0,0,0.9)");
      grad.addColorStop(1, "rgba(0,0,0,0)");
      ctx.fillStyle = grad;
      ctx.beginPath();
      ctx.arc(x, y, config.eraseIntensity, 0, Math.PI * 2);
      ctx.fill();
      ctx.globalCompositeOperation = "source-over";
    }

    function checkCleared(force = false) {
      const now = Date.now();
      if (!force && now - lastCheck < 200) return;
      lastCheck = now;

      const pixels = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
      let total = pixels.length / 4;
      let cleared = 0;

      for (let i = 3; i < pixels.length; i += 4) {
        if (pixels[i] < 128) cleared++;
      }

      const percent = (cleared / total) * 100;
      document.getElementById("currentProgress").textContent = percent.toFixed(1);

      if (!completed && percent >= config.clearThreshold) {
        completed = true;
        triggerWin();
      }
    }

    function triggerWin() {
      audio.play().catch(()=>{});
      flash.classList.add("active");
      setTimeout(() => flash.classList.remove("active"), 500);
    }

    // Eventos Mouse
    canvas.addEventListener("mousedown", (e) => {
      isDrawing = true;
      scratch(...Object.values(getPos(e)));
      checkCleared(true);
    });
    canvas.addEventListener("mousemove", (e) => {
      if (!isDrawing) return;
      scratch(...Object.values(getPos(e)));
      checkCleared();
    });
    canvas.addEventListener("mouseup", () => isDrawing = false);
    canvas.addEventListener("mouseleave", () => isDrawing = false);

    // Eventos Touch
    canvas.addEventListener("touchstart", (e) => {
      isDrawing = true;
      scratch(...Object.values(getPos(e)));
      checkCleared(true);
    });
    canvas.addEventListener("touchmove", (e) => {
      if (!isDrawing) return;
      e.preventDefault();
      scratch(...Object.values(getPos(e)));
      checkCleared();
    }, { passive: false });
    canvas.addEventListener("touchend", () => isDrawing = false);

    loadConfig();
  </script>
</body>
</html>
